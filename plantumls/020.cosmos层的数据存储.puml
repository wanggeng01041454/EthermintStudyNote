@startuml 1.CosmosSDKä¸­-å­˜å‚¨ç›¸å…³çš„ç±»å›¾
    title
        CosmosSDKä¸­-å­˜å‚¨ç›¸å…³çš„ç±»å›¾
    end title

    namespace CosmosSDK {
        namespace baseapp {
            struct appStore #Tomato {
                db dbm.DB // åå°æ•°æ®åº“æ¥å£
                ....
                cms sdk.CommitMultiStore // main state
            }
            struct BaseApp #Tomato {
                state* checkState;
                ....
                state* deliverState;
            }
            note top of BaseApp 
                checkState åœ¨ mode å–ä»¥ä¸‹å€¼æ—¶ä½¿ç”¨:
                * runTxModeCheck
                * runTxModeReCheck
                * runTxModeSimulate
                ====
                deliverState åœ¨ mode å–ä»¥ä¸‹å€¼æ—¶ä½¿ç”¨:
                * runTxModeDeliver
            end note 
            appStore <|- BaseApp : åµŒå…¥ç»§æ‰¿

            struct state {
                types.CacheMultiStore ms;
                ....
                types.Context ctx;
            }

            BaseApp o-[#Tomato]-> state
        } 
        'end baseapp


        namespace types {
            struct Context {
                MultiStore ms;
                ....
                EventManager* eventManager;
            }

            struct EventManager {
                []Event events
            }
            Context o--> EventManager : eventManager å­—æ®µ
        }
        'end types

        namespace snapshots.types {
            interface Snapshotter
        }

        namespace store {

            namespace types {

                interface CacheWrap {
                    Write()
                    ....
                    CacheWrap CacheWrap(); //é€’å½’wrap
                    ....
                    CacheWrap CacheWrapWithTrace(w io.Writer, tc TraceContext)
                }

                interface CacheWrapper {
                    CacheWrap CacheWrap()
                    ....
                    CacheWrap CacheWrapWithTrace(w io.Writer, tc TraceContext)
                }
                CacheWrapper .up.> CacheWrap : æ ¹æ®æ¥å£å®šä¹‰ï¼Œ\n CacheWrapå®é™…ä¸Š \n ç»§æ‰¿äº†CacheWrapper


                ' "ç¬¬ä¸€çº§åŸºç¡€æ¥å£"
                note as StoreType 
                    StoreType çš„å–å€¼ï¼š
                    ----
                    * StoreTypeMulti = 0
                    * StoreTypeDB = 1
                    * StoreTypeIAVL = 2
                    * StoreTypeTransient = 3
                    * StoreTypeMemory = 4
                    * StoreTypeSMT = 5
                    * StoreTypePersistent = 6
                end note 
                interface Store {
                    GetStoreType()
                }
                CacheWrapper <|-- Store
                StoreType <-- Store

                interface BasicKVStore {
                    Get()
                    ....
                    Has()
                    ....
                    Set()
                    ....
                    Delete()
                }
                interface Committer {
                    CommitID Commit()
                    ....
                    CommitID LastCommitID()
                }
                ' end ç¬¬ä¸€çº§åŸºç¡€æ¥å£

                ' ç¬¬äºŒçº§åŸºç¡€æ¥å£
                interface MultiStore #SkyBlue {
                    CacheMultiStore CacheMultiStore()
                }
                Store <|-- MultiStore

                interface KVStore {
                    Iterator Iterator()
                }
                Store <|-- KVStore
                BasicKVStore <|-- KVStore

                interface CommitStore
                Committer <|-- CommitStore
                Store <|-- CommitStore
                ' end ç¬¬äºŒçº§åŸºç¡€æ¥å£


                interface CacheMultiStore {
                    Write()
                }
                MultiStore <|-- CacheMultiStore



                interface CommitMultiStore #LimeGreen {
                    GetCommitStore()
                    ....
                    GetCommitKVStore()
                }
                MultiStore <|-- CommitMultiStore
                Committer <|--- CommitMultiStore



                interface CacheKVStore {
                    Write()
                }
                KVStore <|-- CacheKVStore

                interface CommitKVStore {
                }
                KVStore <|--- CommitKVStore
                Committer <|---[thickness=2]- CommitKVStore
            }

            namespace cachekv {
                struct Store {
                    sync.Mutex
                    ....
                    map[string]*cValue cache
                    ....
                    map[string]struct{} deleted
                    ....
                    map[string]struct{} unsortedCache
                    ....
                    internal.BTree sortedCache
                    ----
                    types.KVStore parent;
                }

            }
            types.CacheKVStore <|--- cachekv.Store : å®ç°æ¥å£
            cachekv.Store o--[#Navy,thickness=1]--> types.KVStore : ç»„åˆæ¨¡å¼; \n parentå­—æ®µ

            namespace cachemulti {
                struct Store {
                    store.types.CacheKVStore db;
                    ....
                    map[types.StoreKey]types.CacheWrap stores;
                    ....
                    map[string]types.StoreKey keys;
                }
            }
            types.CacheMultiStore <|--- cachemulti.Store : å®ç°æ¥å£
            cachemulti.Store o---> types.CacheKVStore : db å­—æ®µ


            namespace rootmulti {
                struct Store {
                    db dbm.DB
                    ....
                    stores map[types.StoreKey]types.CommitKVStore
                }
            }
            types.CommitMultiStore <|-[#DarkGreen,thickness=2]-- rootmulti.Store : å®ç°æ¥å£
            rootmulti.Store o---> types.CommitKVStore : stores å­—æ®µ

            namespace cache {
                struct CommitKVStoreCache {
                    cache *lru.ARCCache
                }
            }
            types.CommitKVStore <|-- cache.CommitKVStoreCache #line.bold : åµŒå…¥æ¥å£ \n å³ç»§æ‰¿ä¹Ÿç»„åˆ

            namespace iavl {
                struct Store #DodgerBlue {
                    tree   Tree
                }
            }
            types.CommitKVStore <|-- iavl.Store #line:RoyalBlue : å®ç°æ¥å£
        }
        'end store

        snapshots.types.Snapshotter <|---- store.types.CommitMultiStore
        baseapp.state o-[#Tomato]-> types.Context : ctx
        baseapp.appStore o--[#Tomato,thickness=2]-> store.types.CommitMultiStore : cms
        types.Context o--[#Tomato,thickness=2]-> store.types.MultiStore : ms

    }


@enduml


@startuml 2. CosmosSDKä¸­-å­˜å‚¨ç›¸å…³çš„å¯¹è±¡å›¾
    title
        CosmosSDKä¸­-å­˜å‚¨ç›¸å…³çš„å¯¹è±¡å›¾
        èŠ‚ç‚¹åˆå§‹åŒ–å®Œæˆæ—¶çš„çŠ¶æ€
    end title

    database db [
        =leveldb
        ----
    ]

    object BaseApp {
        <color:DarkGreen>//åµŒå…¥ appStore å¾—åˆ°çš„å­—æ®µ</color>
        ....
        db
        ....
        cms
        ....
        interBlockCache sdk.MultiStorePersistentCache
        ====
        deliverState *state
        ....
        checkState *state
        ----
    }

    BaseApp o---> db : db å­—æ®µ


    namespace Ethermint {
        object EthermintApp {

        }        
    }

    BaseApp <|- EthermintApp


    namespace store {
        namespace rootmulti {
            object "Store" as rootmultiStore {
                =æ°¸ä¹…å­˜å‚¨
                ====
                db dbm.DB
                ....
                stores map[types.StoreKey]types.CommitKVStore
                ....
                interBlockCache types.MultiStorePersistentCache
            }
            BaseApp *--> rootmultiStore : cms å­—æ®µ
            rootmultiStore o---> db : db å­—æ®µ
        }
        
        namespace iavl {
            object "Store" as iavlStore{
                tree
                ....
                logger
            }
        }

        namespace cache {
            object CommitKVStoreCacheManager {
                size; //åˆå§‹å€¼ä¸º1000
                ----
                caches    map[string]types.CommitKVStore
            }

            object CommitKVStoreCache {
                CommitKVStore: store
                ....
                cache: cache, // = lru.NewARC(int(size))
            }

            CommitKVStoreCacheManager o--> CommitKVStoreCache : storeå­—æ®µ
        }

        note as BaseApp_2_cache_CommitKVStoreCacheManager
            BaseApp.interBlockCache å­—æ®µ
            app.toml ä¸­ inter-block-cache=true æ—¶
            ä¼šåˆ›å»º CommitKVStoreCacheManager å¯¹è±¡
        end note 
        BaseApp o-- BaseApp_2_cache_CommitKVStoreCacheManager
        BaseApp_2_cache_CommitKVStoreCacheManager --> CommitKVStoreCacheManager 

        CommitKVStoreCache o--> iavlStore : store å­—æ®µ


        rootmultiStore o--> cache.CommitKVStoreCacheManager : interBlockCache å­—æ®µ


        note as rootmultiStore_stores_expand
            stores å­—æ®µæ˜¯ä¸€ä¸ª Map, å®ƒçš„ value å­—æ®µä¼šå­˜æ”¾å¤šç§ç±»å‹çš„å¯¹è±¡
            1. CommitKVStoreCache åŒ…è£… åçš„  iavl.Store
            2. transient.Store
            3. mem.Store
        end note 
        rootmultiStore o-- rootmultiStore_stores_expand : stores å­—æ®µ

        rootmultiStore_stores_expand ---> CommitKVStoreCache 
    }

@enduml

@startuml 3.BaseAppä¸­å­˜å‚¨ç›¸å…³å¯¹è±¡çš„åˆå§‹åŒ–æµç¨‹
    title 
        BaseAppä¸­å­˜å‚¨ç›¸å…³å¯¹è±¡çš„åˆå§‹åŒ–æµç¨‹
    end title

    box Ethermint
        participant "<object>ğŸï¸ \n package server ä¸­ \n StartCmd å‡½æ•° \n è¿”å›çš„ cobra.Command å¯¹è±¡" as StartCmd
        participant "<package>ğŸ“¦ï¸ \n package server" as server

        participant "<struct>ğŸš§ \n package main ä¸­ \n appCreator \n å®ƒçš„å®ä¾‹åœ¨NewRootCmdå‡½æ•°ä¸­åˆ›å»º\n å®ƒçš„å®ä¾‹æ²¡æœ‰ä¸“é—¨å­˜å‚¨" as appCreator

        participant "<package>ğŸ“¦ï¸ \n package app" as app
    end box 


    box CosmosSDK
        participant "<package>ğŸ“¦ï¸ \n package server" as cosmosServer

        participant "<package>ğŸ“¦ï¸ \n package baseapp" as baseapp
        participant "<struct>ğŸš§ \n package baseapp \n BaseApp ç»“æ„ä½“" as baseapp_BaseApp

        participant "<package>ğŸ“¦ï¸ \n package store" as store
        participant "<package>ğŸ“¦ï¸ \n package store/rootmulti" as rootmulti
        participant "<struct>ğŸš§ \n package store/rootmulti \n Store ç»“æ„ä½“" as cms

        participant "<struct>ğŸš§ \n package store/cache \n CommitKVStoreCacheManager ç»“æ„ä½“" as CommitKVStoreCacheManager

        participant "<package>ğŸ“¦ï¸ \n package store/iavl" as iavl

        participant "<package>ğŸ“¦ï¸ \n package store/transient" as transient

        participant "<package>ğŸ“¦ï¸ \n package store/mem" as mem

        participant "<package>ğŸ“¦ï¸ \n package store/dbadapter" as dbadapter
    end box 

    autonumber
    autoactivate on

    ->> StartCmd : è¾—è½¬æ¥è‡ª main å‡½æ•°çš„è°ƒç”¨ \
    \n è°ƒç”¨ cobra.Command å¯¹è±¡å®ç°çš„ RunE æ–¹æ³•

        StartCmd -> server : startInProcess(serverCtx, clientCtx, opts)
            note over server
                opts å¯¹åº”çš„ç»“æ„ä½“æ˜¯ package server ä¸­çš„
                ----
                <code>
                type StartOptions struct {
                    AppCreator      types.AppCreator
                    DefaultNodeHome string
                    DBOpener        DBOpener
                }
                </code>
                ----
                å…¶ä¸­çš„ DBOpener æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çš„å‡½æ•°æ˜¯
                cosmos-sdkä¸­ï¼Œ package server ä¸­çš„ GetAppDBBackend å‡½æ•°
            end note 

            server -> cosmosServer : opts.DBOpener(ctx.Viper, home, server.GetAppDBBackend(ctx.Viper))
                note over cosmosServer #SkyBlue
                    ä¼˜å…ˆè¯»å– app.toml ä¸­çš„ app-db-backend å­—æ®µï¼›
                    å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯»å– config.toml ä¸­çš„ db-backend å­—æ®µï¼›
                    <color:red>æ³¨æ„ï¼Œconfig.toml ä¸­æœ‰ä¸€ä¸ª db_backendï¼Œä½†æ²¡æœ‰ db-backend</color>
                    å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼šgoleveldb
                end note 
            return : dbm.DB

            note over server #LimeGreen
                ç•¥è¿‡ä¸€äº›ä»£ç 
            end note 

            note over server
                opts.AppCreator æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘çš„å‡½æ•°æ˜¯
                package main ä¸­ï¼Œ appCreator ç»“æ„ä½“çš„ newApp å‡½æ•°
            end note
            server -> appCreator : opts.AppCreator(ctx.Logger, db, traceWriter, ctx.Viper)
                note over appCreator
                    å½“å‰åœ¨ appCreator.newApp å‡½æ•°ä¸­
                end note 
                note over appCreator
                    cache = store.NewCommitKVStoreCacheManager()
                    cache æŒ‡å‘ CosmosSDK çš„ store.cache.CommitKVStoreCacheManager ç»“æ„ä½“
                end note 

                appCreator -> app : app.NewEthermintApp
                    note over appCreator, app 
                        å‚æ•° baseAppOptions æ˜¯ä¸€ä¸ªé—­åŒ…å‡½æ•°åˆ—è¡¨ï¼Œ 
                        åŒ…å«äº†å¾ˆå¤šä¸º BaseApp è®¾ç½®å‚æ•°çš„é—­åŒ…å‡½æ•°
                        å…¶ä¸­ï¼Œå°±æœ‰ baseapp.SetInterBlockCache(cache)
                    end note 

                    app -> baseapp : baseapp.NewBaseApp
                        baseapp -> store : store.NewCommitMultiStore(db)
                            store -> rootmulti : rootmulti.NewStore(db,)
                            return : cms
                        return : cms 
                    return :bApp

                    note over app 
                        keys = sdk.NewKVStoreKeys(...keys)
                        ----
                        keys æ˜¯ä¸€ä¸ª map[string]*sdk.KVStoreKey
                        KVStoreKey å†…éƒ¨åªæœ‰ä¸€ä¸ªå­—æ®µ name string
                        ....
                        è¿™æ®µä»£ç åšçš„å·¥ä½œå®é™…ä¸Šæ˜¯å»ºç«‹äº†æ˜ å°„ï¼š
                        "xxx" => KVStoreKey{"xxx"}
                        ====
                        ä¸‹é¢çš„ tKeys, memKeys æ˜¯åŒæ ·çš„é“ç†
                    end note

                    note over app
                        app := &EthermintApp{...}
                        ....
                        åœ¨ EthermintApp ä¸­ï¼Œè®°å½•äº† keys, tKeys, memKeys
                    end note 

                    note over app 
                        åˆå§‹åŒ– app ä¸­çš„å„ä¸ª Keeper
                    end note 

                    note over app
                        åˆå§‹åŒ– app.mm; module manager
                    end note 

                    note over app
                        é€šè¿‡ module manager æ³¨å†Œè·¯ç”±
                        ----
                        app.mm.RegisterRoutes(...)
                        app.mm.RegisterServices(...)
                    end note 

                    group#DodgerBlue  "å­˜å‚¨åˆå§‹åŒ–" 
                        app -> baseapp_BaseApp #LimeGreen : app.MountKVStores(keys)
                            loop "éå† kyes çš„æ‰€æœ‰ k,v"
                                note over baseapp_BaseApp 
                                    å¿½ç•¥k,
                                    å˜é‡ key = v, 
                                    key æ˜¯ä¸€ä¸ª *sdk.KVStoreKey
                                end note
                                baseapp_BaseApp -> baseapp_BaseApp #DeepSkyBlue : app.MountStore(key, storetypes.StoreTypeIAVL)
                                    baseapp_BaseApp -> cms : app.cms.MountStoreWithDB(key, typ, nil)
                                        note over cms
                                            åˆå§‹åŒ–äº† Store(app.cms) ä¸­çš„ 
                                            =1. <color:red>storesParams
                                            =2. <color:red>keysByName
                                            ä¸¤ä¸ªå­—æ®µ
                                            ----
                                            <code>
                                            rs.storesParams[key] = newStoreParams(key, db, typ, 0)
                                            rs.keysByName[key.Name()] = key
                                            </code>
                                        end note
                                    return
                                return
                            end loop
                        return
                        note over app
                            app.MountTransientStores(tkeys)
                            app.MountMemoryStores(memKeys)
                            å’Œä¸Šé¢çš„ app.MountKVStores(keys) æµç¨‹ä¸€è‡´
                        end note 
                    end group

                    group#DodgerBlue #LightBlue "loadLatest å›ºå®šä¸ºtrueï¼› æ‰§è¡Œ app.LoadLatestVersion()"
                        note over app 
                            app.LoadLatestVersion() æ˜¯ baseapp.BaseApp çš„æ–¹æ³•
                        end note 
                        app -> baseapp_BaseApp #LimeGreen : app.LoadLatestVersion()
                            note over baseapp_BaseApp
                                app.storeLoader è¢«åˆå§‹åŒ–ä¸º baseapp.DefaultStoreLoader
                            end note
                            baseapp_BaseApp -> baseapp : app.storeLoader(app.cms)
                                note over baseapp
                                    åœ¨ baseapp.DefaultStoreLoader å‡½æ•°ä¸­
                                    ----
                                    <code>
                                    func DefaultStoreLoader(ms sdk.CommitMultiStore) error {
                                        return ms.LoadLatestVersion()
                                    }
                                    </code>
                                end note

                                baseapp -> cms : ms.LoadLatestVersion()
                                    note over cms
                                        ver := GetLatestVersion(rs.db)
                                        ----
                                        ä»leveldbä¸­å–å‡º key="s/latest" å¯¹åº”çš„ value
                                        è§£ç åï¼Œå°±æ˜¯ version å€¼
                                    end note 
                                    
                                    cms -> cms #LimeGreen : rs.loadVersion(ver, nil)
                                        alt "ver != 0"
                                            cms -> rootmulti : getCommitInfo(rs.db, ver)
                                                note over rootmulti
                                                    ä»¥ ï¼ˆ"s/%d", versionï¼‰ ä¸º key 
                                                    ä» leveldb ä¸­å–å‡º value
                                                    è¯¥ value è§£ç åï¼Œå°±æ˜¯ CommitInfo ç»“æ„ä½“
                                                end note 
                                            return : cInfo *types.CommitInfo

                                            note over cms
                                                cInfo ä¸­æœ‰ä¸€ä¸ª types.StoreInfo æ•°ç»„
                                                å°†å®ƒæŒ‰ storeInfo.Name => storeInfo æ‹¼æˆä¸€ä¸ª map
                                                è¿™ä¸ªmapåä¸º  infos
                                                ----
                                                <code>
                                                infos[storeInfo.Name] = storeInfo
                                                </code>
                                            end note 

                                            note over cms
                                                å–å‡º cms.storesParams ä¸­çš„æ‰€æœ‰ key
                                                å­˜æ”¾åœ¨å˜é‡ storesKeys ä¸­
                                                ----
                                                å‡†å¤‡ä¸€ä¸ªå’Œ cms.stores ç±»å‹ä¸€æ ·çš„ç©ºæ–°å˜é‡ newStores
                                            end note 
                                            loop "éå† storesKeys, å…ƒç´ èµ‹å€¼ç»™ key"
                                                note over cms
                                                    å–å‡º key å¯¹åº”çš„ storeParams
                                                    storeParams := rs.storesParams[key]
                                                    ....
                                                    ä» infos ä¸­ å–å‡º commitID
                                                    commitID := rs.getCommitID(infos, key.Name())
                                                end note 

                                                cms -> cms #DeepSkyBlue : rs.loadCommitStoreFromParams(key, commitID, storeParams)
                                                    note over cms
                                                        æ¯ä¸ª key å¯¹åº”çš„æ•°æ®åº“ï¼Œä½¿ç”¨ s/k:<param.key.Name()>/ æœ€ä¸ºå‰ç¼€ç”Ÿæˆçš„æ–° æ•°æ®åº“
                                                    end note 
                                                    alt "param.typ == types.StoreTypeIAVL"
                                                        note over cms 
                                                            è¿™æ˜¯ EthermintApp.keys ä¸­çš„ key å¯¹åº”çš„ç±»å‹
                                                        end note

                                                        alt "params.initialVersion == 0"
                                                            cms -> iavl : iavl.LoadStore(db, rs.logger, key, id, rs.lazyLoading, rs.iavlCacheSize, rs.iavlDisableFastNode)
                                                            return : store
                                                        else "params.initialVersion != 0"
                                                            cms -> iavl : iavl.LoadStoreWithInitialVersion(db, rs.logger, key, id, rs.lazyLoading, params.initialVersion, rs.iavlCacheSize, rs.iavlDisableFastNode)
                                                            return : store
                                                        end alt
                                                        
                                                        cms -> CommitKVStoreCacheManager : rs.interBlockCache.GetStoreCache(key, store)
                                                            note over cms, CommitKVStoreCacheManager
                                                                <color:red>å†ä¸º store è£¹ä¸€å±‚ cache
                                                                ----
                                                                <code>
                                                                cmgr.caches[key.Name()] = NewCommitKVStoreCache(store, cmgr.cacheSize)
                                                                return cmgr.caches[key.Name()]
                                                                </code>
                                                            end note
                                                        return : store
                                                            
                                                    else #LightPink "param.typ == types.StoreTypeTransient"
                                                        note over cms 
                                                            è¿™æ˜¯ EthermintApp.tKeys ä¸­çš„ key å¯¹åº”çš„ç±»å‹
                                                        end note
                                                        cms -> transient : transient.NewStore()
                                                        return : store
                                                    else "param.typ == types.StoreTypeMemory"
                                                        note over cms 
                                                            è¿™æ˜¯ EthermintApp.memKeys ä¸­çš„ key å¯¹åº”çš„ç±»å‹
                                                        end note
                                                        cms -> mem : mem.NewStore()
                                                        return : store
                                                    else #LightPink "param.typ == types.StoreTypeDB"
                                                        cms -> dbadapter : dbadapter.NewStore(db)
                                                        return : store
                                                        note over cms
                                                            return commitDBStoreAdapter{Store: dbadapter.Store{DB: db}}
                                                        end note 
                                                    end alt
                                                return : store
                                            end loop 
                                        end alt 
                                    return
                                return
                            return
                        return
                    end group

                return : ethermintApp
            return : app
        return

    return


@enduml